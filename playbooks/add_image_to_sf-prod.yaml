---
- name: Add (any Linux) image to sf-prod Glance
  hosts: nodepool-builder
  vars:
    - file_name: "{{ image_url | basename }}"
    - image_name: "{{ file_name.split('.')[0] }}"

  tasks:  
    - name: Obtain and extract the image
      unarchive:
        url: "{{ image_url }}"
        dest: /tmp
        copy: no
        list_files: yes
      register: output

    - name: Obtain the zuul public SSH key
      get_url:
        url: https://softwarefactory-project.io/keys/zuul_rsa.pub
        dest: /tmp/authorized_keys

    - name: Customize the image
      command: >
      virt-customize -a /tmp/{{ output.files[0] }}
      --run-command 'adduser zuul-worker'
      --run-command 'mkdir /home/zuul-worker/.ssh'
      --chmod '0700:/home/zuul-worker/.ssh'
      --copy-in '/tmp/authorized_keys:/home/zuul-worker/.ssh'
      --chmod '0600:/home/zuul-worker/.ssh/authorized_keys'
      --run-command 'chown -R zuul-worker:zuul-worker /home/zuul-worker/.ssh/'
      --run-command 'touch /.autorelabel'

    - name: Create the image in RDO cloud
      command: >
      openstack --os-cloud=rdo-cloud image create
      --disk-format raw
      --container-format bare
      --file /tmp/{{ output.files[0] }}
      sf-{{ image_name }}
